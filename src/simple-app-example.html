<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=2"
    />
    <title>ImJoy Simple App Example</title>
  </head>

  <body>
    <div id="window-container"></div>
    <div id="menu-container"></div>
    <script src="/imjoy-loader.js"></script>
    <script>
      loadImJoyBasicApp({
        base_url: "/",
        debug: true,
        process_url_query: true,
        show_window_title: true,
        show_progress_bar: true,
        show_empty_window: true,
        hide_about_imjoy: false,
        menu_style: { position: "absolute", right: 0, top: 0, zIndex: 9999 },
        window_style: { width: "100%", height: "calc(100% - 30px)" },
        main_container: null,
        menu_container: "menu-container",
        window_manager_container: "window-container",
        imjoy_api: {},
      }).then(async app => {
        const api = app.imjoy.api;
        app.addDesktopItem({
          name: "elFinder",
          icon:
            "https://raw.githubusercontent.com/imjoy-team/elFinder/master/img/imjoy-elfinder-icon.svg",
          async callback() {
            await api.createWindow({ src: "http://127.0.0.1:9876/" }); //"https://imjoy-team.github.io/elFinder/"})
          },
        });
        app.addDesktopItem({
          name: "Kaibu",
          icon: "https://kaibu.org/static/img/kaibu-icon.svg",
          async callback() {
            await api.createWindow({ src: "https://kaibu.org" });
          },
          contextMenuItems: [
            {
              type: "multi",
              items: [
                {
                  label: "Copy",
                  onClick: () => {
                    console.log("Copy!");
                  },
                },
                {
                  label: "Cut",
                  onClick: () => {
                    console.log("Cut!");
                  },
                },
                {
                  label: "Paste",
                  onClick: () => {
                    console.log("Paste!");
                  },
                },
              ],
            },
            {
              label: "Button",
              onClick: () => {
                console.log("Item 1 clicked");
              },
              shortcut: "Ctrl+A",
            },
            { type: "seperator" },
            {
              type: "submenu",
              label: "Sub menu",
              items: [
                { label: "Subitem 1", onClick: () => {} },
                { label: "Subitem 2", onClick: () => {} },
                { label: "Subitem 3", onClick: () => {} },
              ],
            },
            {
              type: "hovermenu",
              label: "Hover menu",
              items: [
                { label: "Subitem 1", onClick: () => {} },
                { label: "Subitem 2", onClick: () => {} },
                { label: "Subitem 3", onClick: () => {} },
              ],
            },
            {
              label: "Disabled button",
              onClick: () => {},
              shortcut: "Ctrl+B",
              enabled: false,
            },
          ],
        });
        app.addMenuItem({
          label: "âž• Load Plugin",
          callback() {
            const uri = prompt(
              `Please type a ImJoy plugin URL`,
              "https://github.com/imjoy-team/imjoy-plugins/blob/master/repository/ImageAnnotator.imjoy.html"
            );
            if (uri) app.loadPlugin(uri);
          },
        });
        const kaibu = await api.createWindow({
          src: "https://kaibu.org",
        });
        await kaibu.view_image(
          "https://images.proteinatlas.org/61448/1319_C10_2_blue_red_green.jpg"
        );
        await api.showSnackbar("This is a message", 5);
        await api.showProgress(60);
        // const vizarr = await api.showDialog({
        //   src: "https://hms-dbmi.github.io/vizarr/",
        // });
        // await vizarr.add_image({
        //   source: "https://s3.embassy.ebi.ac.uk/idr/zarr/v0.1/4495402.zarr",
        // });

        function urlToBase64(url) {
          return new Promise(async (resolve, reject) => {
            const response = await fetch(url);
            const blob = await response.blob();
            const reader = new FileReader();
            reader.onload = function() {
              resolve(this.result);
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        }
        await api.registerService({
          type: "#file-loader",
          name: "Kaibu",
          icon: "https://kaibu.org/static/img/kaibu-icon.svg",
          async check(fileObj) {
            if (
              fileObj.mime.startsWith("image/") ||
              fileObj.mime === "directory"
            ) {
              return true;
            }
          },
          async load({ source, type, window_id }) {
            if (type === "file") {
              const base64 = await urlToBase64(source.url);
              const viewer = await api.createWindow({
                src: "https://kaibu.org/",
                window_id,
                w: 10,
                h: 10,
              });
              await viewer.view_image(base64, { name: source.name });
              await viewer.add_shapes([], { name: "annotation" });
            } else if (type === "directory") {
              const viewer = await api.createWindow({
                src: "https://kaibu.org/",
                window_id,
                w: 10,
                h: 10,
              });
              source = source.filter(file => file.mime.startsWith("image/"));
              const nodes = source.map(file => {
                return { title: file.name, data: file, isLeaf: true };
              });
              await viewer.add_widget({
                _rintf: true,
                type: "tree",
                name: "Files",
                node_dbclick_callback: async node => {
                  await viewer.clear_layers();
                  const file = node.data;
                  const base64 = await urlToBase64(file.url);
                  await viewer.view_image(base64, { name: file.name });
                },
                nodes: nodes,
              });
              await viewer.add_shapes([], { name: "annotation" });
            }
          },
        });
      });
    </script>
  </body>
</html>
